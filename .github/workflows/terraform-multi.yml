name: terraform-multi

on:
  workflow_call:
    inputs:
      environment:      { type: string,  required: true }
      tfvars_file:      { type: string,  required: true }
      rgname:           { type: string,  required: true }
      saname:           { type: string,  required: true }
      scname:           { type: string,  required: true }
      key:              { type: string,  required: true }

      runInit:          { type: boolean, default: false }
      runFmt:           { type: boolean, default: false }
      runValidate:      { type: boolean, default: false }
      runPlan:          { type: boolean, default: false }
      runApply:         { type: boolean, default: false }
      runDestroy:       { type: boolean, default: false }

      # separate approval toggles
      useEnvironmentInit:    { type: boolean, default: true }
      useEnvironmentApply:   { type: boolean, default: true }
      useEnvironmentDestroy: { type: boolean, default: true }

    secrets:
      AZURE_CLIENT_ID:       { required: true }
      AZURE_TENANT_ID:       { required: true }
      AZURE_SUBSCRIPTION_ID: { required: true }

permissions:
  id-token: write
  contents: read

jobs:
  # --- DEBUG: to see what values we received (remove later if you want) ---
  debug_inputs:
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "runInit=${{ inputs.runInit }}"
          echo "runFmt=${{ inputs.runFmt }}"
          echo "runValidate=${{ inputs.runValidate }}"
          echo "runPlan=${{ inputs.runPlan }}"
          echo "runApply=${{ inputs.runApply }}"
          echo "runDestroy=${{ inputs.runDestroy }}"
          echo "useEnvironmentApply=${{ inputs.useEnvironmentApply }}"
          echo "useEnvironmentDestroy=${{ inputs.useEnvironmentDestroy }}"

  init_with_env:
    if: ${{ and(inputs.runInit, inputs.useEnvironmentInit) }}
    # if: ${{ inputs.runInit && inputs.useEnvironmentInit }}
    runs-on: self-hosted    # apne Windows runner labels yaha daal do (X64 ya custom labels bhi)
    environment:
      name: ${{ inputs.environment }}  # e.g., "prod" â€” yahi env me reviewers set honge
    defaults:
      run:
        working-directory: infra
    steps:
      - uses: actions/checkout@v4

      - uses: Azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Terraform Init (remote backend)
        run: terraform init -input=false -backend-config="resource_group_name=${{ inputs.rgname }}" -backend-config="storage_account_name=${{ inputs.saname }}" -backend-config="container_name=${{ inputs.scname }}" -backend-config="key=${{ inputs.key }}"

  # ---------- INIT DIRECT (no approval) ----------
  init_direct:
    if: ${{ and(inputs.runInit, not(inputs.useEnvironmentInit)) }}
    # if: ${{ inputs.runInit && !inputs.useEnvironmentInit }}
    runs-on: self-hosted    # same runner, no environment (no approval)
    defaults:
      run:
        working-directory: infra
    steps:
      - uses: actions/checkout@v4

      - uses: Azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Terraform Init (remote backend)
        run: terraform init -input=false -backend-config="resource_group_name=${{ inputs.rgname }}" -backend-config="storage_account_name=${{ inputs.saname }}" -backend-config="container_name=${{ inputs.scname }}" -backend-config="key=${{ inputs.key }}"

  # fmt:
  #   needs: [init]
  #   if: ${{ always() && inputs.runFmt && needs.init.result == 'success' }}
  #   runs-on: self-hosted
  #   defaults: { run: { working-directory: infra } }
  #   steps:
  #     - uses: actions/checkout@v4
  #     - run: terraform fmt

  # validate:
  #   needs: [fmt, init]
  #   if: ${{ always()
  #           && inputs.runValidate
  #           && (
  #                ( inputs.runFmt  && needs.fmt.result  == 'success' ) ||
  #                ( !inputs.runFmt && needs.init.result == 'success' )
  #              )
  #        }}
  #   runs-on: self-hosted
  #   defaults: { run: { working-directory: infra } }
  #   steps:
  #     - uses: actions/checkout@v4
  #     # ðŸ‘‡ install modules locally; backend touch nahi karega
  #     - name: Terraform Init (for validate)
  #       run: terraform init -input=false -backend=false
  #     - name: Terraform validate
  #       run: terraform validate


  # plan:
  #   needs: [validate, fmt, init]
  #   if: ${{ always() && inputs.runPlan &&
  #           ((inputs.runValidate && needs.validate.result == 'success') ||
  #            (!inputs.runValidate && inputs.runFmt && needs.fmt.result == 'success') ||
  #            (!inputs.runValidate && !inputs.runFmt && needs.init.result == 'success')) }}
  #   runs-on: self-hosted
  #   defaults: { run: { working-directory: infra } }
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: Azure/login@v2
  #       with:
  #         client-id: ${{ secrets.AZURE_CLIENT_ID }}
  #         tenant-id: ${{ secrets.AZURE_TENANT_ID }}
  #         subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  #     - name: Terraform Init (remote backend)
  #       run: terraform init -input=false -backend-config="resource_group_name=${{ inputs.rgname }}" -backend-config="storage_account_name=${{ inputs.saname }}" -backend-config="container_name=${{ inputs.scname }}" -backend-config="key=${{ inputs.key }}"
        
  #     - name: Terraform plan
  #       run: terraform plan -var-file="../${{ inputs.tfvars_file }}" -out="plan-${{ inputs.environment }}.tfplan"
  #     - uses: actions/upload-artifact@v4
  #       with:
  #         name: tf-plan-${{ inputs.environment }}
  #         path: infra/plan-${{ inputs.environment }}.tfplan
  #         if-no-files-found: error

  # # ===== APPLY =====
  # apply_protected:
  #   needs: [plan]
  #   if: ${{ inputs.runApply && inputs.useEnvironmentApply && needs.plan.result == 'success' }}
  #   runs-on: self-hosted
  #   environment: ${{ inputs.environment }}
  #   defaults: { run: { working-directory: infra } }
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: Azure/login@v2
  #       with:
  #         client-id:       ${{ secrets.AZURE_CLIENT_ID }}
  #         tenant-id:       ${{ secrets.AZURE_TENANT_ID }}
  #         subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  #     - name: Terraform Init (remote backend)
  #       run: terraform init -input=false -backend-config="resource_group_name=${{ inputs.rgname }}" -backend-config="storage_account_name=${{ inputs.saname }}" -backend-config="container_name=${{ inputs.scname }}" -backend-config="key=${{ inputs.key }}"
  #     - uses: actions/download-artifact@v4
  #       with:
  #         name: tf-plan-${{ inputs.environment }}
  #         path: infra
  #     - run: terraform apply -auto-approve "plan-${{ inputs.environment }}.tfplan"


  # apply_unprotected:
  #   needs: [plan]
  #   if: ${{ inputs.runApply && !inputs.useEnvironmentApply && needs.plan.result == 'success' }}
  #   runs-on: self-hosted
  #   defaults: { run: { working-directory: infra } }
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: Azure/login@v2
  #       with:
  #         client-id:       ${{ secrets.AZURE_CLIENT_ID }}
  #         tenant-id:       ${{ secrets.AZURE_TENANT_ID }}
  #         subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  #     - name: Terraform Init (remote backend)
  #       run: terraform init -input=false -backend-config="resource_group_name=${{ inputs.rgname }}" -backend-config="storage_account_name=${{ inputs.saname }}" -backend-config="container_name=${{ inputs.scname }}" -backend-config="key=${{ inputs.key }}"
  #     - uses: actions/download-artifact@v4
  #       with:
  #         name: tf-plan-${{ inputs.environment }}
  #         path: infra
  #     - run: terraform apply -auto-approve "plan-${{ inputs.environment }}.tfplan"



  # # ===== DESTROY =====
  # destroy_protected:
  #   needs: [init, fmt, validate, plan, apply_protected, apply_unprotected]
  #   if: >-
  #     ${{ inputs.runDestroy
  #         && inputs.useEnvironmentDestroy
  #         && (
  #              ( inputs.runApply &&
  #                (
  #                  (  inputs.useEnvironmentApply  && needs.apply_protected.result   == 'success' ) ||
  #                  ( !inputs.useEnvironmentApply && needs.apply_unprotected.result == 'success' )
  #                )
  #              ) ||
  #              ( !inputs.runApply && inputs.runPlan      && needs.plan.result      == 'success' ) ||
  #              ( !inputs.runApply && !inputs.runPlan && inputs.runValidate && needs.validate.result == 'success' ) ||
  #              ( !inputs.runApply && !inputs.runPlan && !inputs.runValidate && inputs.runFmt && needs.fmt.result == 'success' ) ||
  #              ( !inputs.runApply && !inputs.runPlan && !inputs.runValidate && !inputs.runFmt && inputs.runInit && needs.init.result == 'success' ) ||
  #              ( !inputs.runApply && !inputs.runPlan && !inputs.runValidate && !inputs.runFmt && !inputs.runInit )
  #            )
  #       }}
  #   runs-on: self-hosted
  #   environment: ${{ inputs.environment }}
  #   defaults: { run: { working-directory: infra } }
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: Azure/login@v2
  #       with:
  #         client-id:       ${{ secrets.AZURE_CLIENT_ID }}
  #         tenant-id:       ${{ secrets.AZURE_TENANT_ID }}
  #         subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  #     - name: Terraform Init (remote backend)
  #       run: terraform init -input=false -backend-config="resource_group_name=${{ inputs.rgname }}" -backend-config="storage_account_name=${{ inputs.saname }}" -backend-config="container_name=${{ inputs.scname }}" -backend-config="key=${{ inputs.key }}"
  #     - name: Terraform destroy (protected)
  #       run: terraform destroy -auto-approve -var-file="../${{ inputs.tfvars_file }}"



  
  
  # destroy_unprotected:
  #   needs: [init, fmt, validate, plan, apply_protected, apply_unprotected]
  #   if: >-
  #     ${{ inputs.runDestroy
  #         && !inputs.useEnvironmentDestroy
  #         && (
  #              ( inputs.runApply &&
  #                (
  #                  (  inputs.useEnvironmentApply  && needs.apply_protected.result   == 'success' ) ||
  #                  ( !inputs.useEnvironmentApply && needs.apply_unprotected.result == 'success' )
  #                )
  #              ) ||
  #              ( !inputs.runApply && inputs.runPlan      && needs.plan.result      == 'success' ) ||
  #              ( !inputs.runApply && !inputs.runPlan && inputs.runValidate && needs.validate.result == 'success' ) ||
  #              ( !inputs.runApply && !inputs.runPlan && !inputs.runValidate && inputs.runFmt && needs.fmt.result == 'success' ) ||
  #              ( !inputs.runApply && !inputs.runPlan && !inputs.runValidate && !inputs.runFmt && inputs.runInit && needs.init.result == 'success' ) ||
  #              ( !inputs.runApply && !inputs.runPlan && !inputs.runValidate && !inputs.runFmt && !inputs.runInit )
  #            )
  #       }}
  #   runs-on: self-hosted
  #   defaults: { run: { working-directory: infra } }
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: Azure/login@v2
  #       with:
  #         client-id:       ${{ secrets.AZURE_CLIENT_ID }}
  #         tenant-id:       ${{ secrets.AZURE_TENANT_ID }}
  #         subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  #     - name: Terraform Init (remote backend)
  #       run: terraform init -input=false -backend-config="resource_group_name=${{ inputs.rgname }}" -backend-config="storage_account_name=${{ inputs.saname }}" -backend-config="container_name=${{ inputs.scname }}" -backend-config="key=${{ inputs.key }}"
  #     - name: Terraform destroy (unprotected)
  #       run: terraform destroy -auto-approve -var-file="../${{ inputs.tfvars_file }}"
