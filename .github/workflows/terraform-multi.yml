name: terraform-multi

on:
  workflow_call:
    inputs:
      environment: { required: true, type: string }
      tfvars_file: { required: true, type: string }
      rgname:      { required: true, type: string }
      saname:      { required: true, type: string }
      scname:      { required: true, type: string }
      key:         { required: true, type: string }
      runInit:     { type: boolean, default: true }
      runFmt:      { type: boolean, default: false }
      runValidate: { type: boolean, default: false }
      runPlan:     { type: boolean, default: false }
      runApply:    { type: boolean, default: false }
      runDestroy:  { type: boolean, default: false }
      # üëá NEW: caller se decide hoga environment lagana hai ya nahi
      use_env_apply:   { type: boolean, default: false }
      use_env_destroy: { type: boolean, default: false }
    secrets:
      AZURE_CLIENT_ID:      { required: true }
      AZURE_TENANT_ID:      { required: true }
      AZURE_SUBSCRIPTION_ID:{ required: true }

permissions: { id-token: write, contents: read }

# ---------- ANCHORS: common step blocks ----------
x-apply-steps: &apply_steps
  - uses: actions/checkout@v4
  - uses: azure/login@v2
    with:
      client-id: ${{ secrets.AZURE_CLIENT_ID }}
      tenant-id: ${{ secrets.AZURE_TENANT_ID }}
      subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  - uses: actions/download-artifact@v4
    with:
      name: tf-plan-${{ inputs.environment }}
      path: infra
  - name: Terraform init (readonly)
    run: >
      terraform init -input=false -lockfile=readonly
      -backend-config="resource_group_name=${{ inputs.rgname }}"
      -backend-config="storage_account_name=${{ inputs.saname }}"
      -backend-config="container_name=${{ inputs.scname }}"
      -backend-config="key=${{ inputs.key }}"
  - name: Terraform apply
    run: terraform apply -auto-approve "plan-${{ inputs.environment }}.tfplan"

x-destroy-steps: &destroy_steps
  - uses: actions/checkout@v4
  - uses: azure/login@v2
    with:
      client-id: ${{ secrets.AZURE_CLIENT_ID }}
      tenant-id: ${{ secrets.AZURE_TENANT_ID }}
      subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  - name: Terraform init
    run: >
      terraform init -input=false
      -backend-config="resource_group_name=${{ inputs.rgname }}"
      -backend-config="storage_account_name=${{ inputs.saname }}"
      -backend-config="container_name=${{ inputs.scname }}"
      -backend-config="key=${{ inputs.key }}"
  - name: Terraform destroy
    run: terraform destroy -auto-approve -var-file="../${{ inputs.tfvars_file }}"

jobs:
  init:
    if: ${{ inputs.runInit }}
    runs-on: self-hosted
    defaults: { run: { working-directory: infra } }
    steps:
      - uses: actions/checkout@v4
      - uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Terraform Init (backend)
        run: >
          terraform init -input=false
          -backend-config="resource_group_name=${{ inputs.rgname }}"
          -backend-config="storage_account_name=${{ inputs.saname }}"
          -backend-config="container_name=${{ inputs.scname }}"
          -backend-config="key=${{ inputs.key }}"

  fmt:
    if: ${{ inputs.runFmt }}
    needs: [init]
    runs-on: self-hosted
    defaults: { run: { working-directory: infra } }
    steps:
      - uses: actions/checkout@v4
      - run: terraform fmt -check -recursive || terraform fmt -recursive

  validate:
    if: ${{ inputs.runValidate }}
    needs: [init]    # fmt optional
    runs-on: self-hosted
    defaults: { run: { working-directory: infra } }
    steps:
      - uses: actions/checkout@v4
      - run: terraform validate

  plan:
    if: ${{ inputs.runPlan }}
    needs: [validate, init]
    runs-on: self-hosted
    defaults: { run: { working-directory: infra } }
    steps:
      - uses: actions/checkout@v4
      - uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Terraform Init (for plan)
        run: >
          terraform init -input=false
          -backend-config="resource_group_name=${{ inputs.rgname }}"
          -backend-config="storage_account_name=${{ inputs.saname }}"
          -backend-config="container_name=${{ inputs.scname }}"
          -backend-config="key=${{ inputs.key }}"
      - name: Terraform Plan
        run: terraform plan -var-file="../${{ inputs.tfvars_file }}" -out="plan-${{ inputs.environment }}.tfplan"
      - name: Upload plan bundle
        uses: actions/upload-artifact@v4
        with:
          name: tf-plan-${{ inputs.environment }}
          path: |
            infra/plan-${{ inputs.environment }}.tfplan
            infra/.terraform.lock.hcl
          if-no-files-found: error

  # ==== APPLY (with env) ‚Äì thin wrapper, steps reused ====
  apply_with_env:
    if: ${{ inputs.runApply && inputs.use_env_apply }}
    needs: [plan, validate, init]
    runs-on: self-hosted
    environment: ${{ inputs.environment }}      # ‚Üê sirf yahan
    defaults: { run: { working-directory: infra } }
    steps: *apply_steps                           # ‚Üê alias

  # ==== APPLY (no env) ‚Äì same steps reused ====
  apply_no_env:
    if: ${{ inputs.runApply && !inputs.use_env_apply }}
    needs: [plan, validate, init]
    runs-on: self-hosted
    defaults: { run: { working-directory: infra } }
    steps: *apply_steps

  # ==== DESTROY (with env) ====
  destroy_with_env:
    if: ${{ inputs.runDestroy && inputs.use_env_destroy }}
    needs: [apply_with_env, apply_no_env, plan, validate, init]
    runs-on: self-hosted
    environment: ${{ inputs.environment }}
    defaults: { run: { working-directory: infra } }
    steps: *destroy_steps

  # ==== DESTROY (no env) ====
  destroy_no_env:
    if: ${{ inputs.runDestroy && !inputs.use_env_destroy }}
    needs: [apply_with_env, apply_no_env, plan, validate, init]
    runs-on: self-hosted
    defaults: { run: { working-directory: infra } }
    steps: *destroy_steps
