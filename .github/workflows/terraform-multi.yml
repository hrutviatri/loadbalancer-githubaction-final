name: terraform-multi

on:
  workflow_call:
    inputs:
      environment:      { type: string,  required: true }
      tfvars_file:      { type: string,  required: true }
      rgname:           { type: string,  required: true }
      saname:           { type: string,  required: true }
      scname:           { type: string,  required: true }
      key:              { type: string,  required: true }

      runInit:          { type: boolean, default: false }
      runPlan:          { type: boolean, default: false }
      runApply:         { type: boolean, default: false }
      runDestroy:       { type: boolean, default: false }

      useEnvironmentInit:    { type: boolean, default: false }
      useEnvironmentPlan:    { type: boolean, default: false }
      useEnvironmentApply:   { type: boolean, default: false }
      useEnvironmentDestroy: { type: boolean, default: false }

    secrets:
      AZURE_CLIENT_ID:       { required: true }
      AZURE_TENANT_ID:       { required: true }
      AZURE_SUBSCRIPTION_ID: { required: true }


permissions:
  id-token: write
  contents: read


env:
  WORKDIR: infra

  
jobs:

  # add this job in your prod workflow (runs on ubuntu-latest)
  preview-options:
    name: Preview selected options
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Show event info
        run: |
          echo "GITHUB EVENT: ${{ github.event_name }}"
          echo "REF: ${{ github.ref }}"
          echo ""

      - name: Compute and print inputs + derived toggles
        env:
          # raw inputs (workflow_dispatch boolean inputs)
          input_use_environment_init:    ${{ inputs.use_environment_init }}
          input_do_init:                 ${{ inputs.do_init }}
          input_use_environment_plan:    ${{ inputs.use_environment_plan }}
          input_do_plan:                 ${{ inputs.do_plan }}
          input_use_environment_apply:   ${{ inputs.use_environment_apply }}
          input_do_apply:                ${{ inputs.do_apply }}
          input_use_environment_destroy: ${{ inputs.use_environment_destroy }}
          input_do_destroy:              ${{ inputs.do_destroy }}

          # Derived run toggles (what your reusable workflow expects)
          # run on push OR when corresponding input is true
          run_init:   ${{ github.event_name == 'push' || inputs.do_init }}
          run_plan:   ${{ github.event_name == 'push' || inputs.do_plan }}
          run_apply:  ${{ github.event_name == 'push' || inputs.do_apply }}
          run_destroy: ${{ github.event_name == 'workflow_dispatch' && inputs.do_destroy }}

          # Derived environment-approval toggles: push should force approval for apply
          use_env_init:    ${{ github.event_name == 'workflow_dispatch' && inputs.use_environment_init }}
          use_env_plan:    ${{ github.event_name == 'workflow_dispatch' && inputs.use_environment_plan }}
          use_env_apply:   ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.use_environment_apply) }}
          use_env_destroy: ${{ github.event_name == 'workflow_dispatch' && inputs.use_environment_destroy }}
        run: |
          echo "---- Raw inputs (workflow_dispatch) ----"
          echo "use_environment_init:    $input_use_environment_init"
          echo "do_init:                 $input_do_init"
          echo "use_environment_plan:    $input_use_environment_plan"
          echo "do_plan:                 $input_do_plan"
          echo "use_environment_apply:   $input_use_environment_apply"
          echo "do_apply:                $input_do_apply"
          echo "use_environment_destroy: $input_use_environment_destroy"
          echo "do_destroy:              $input_do_destroy"
          echo ""

          echo "---- Derived run toggles (will be passed to reusable workflow) ----"
          echo "runInit:     $run_init"
          echo "runPlan:     $run_plan"
          echo "runApply:    $run_apply"
          echo "runDestroy:   $run_destroy"
          echo ""

          echo "---- Derived environment (approval) toggles ----"
          echo "useEnvironmentInit:    $use_env_init"
          echo "useEnvironmentPlan:    $use_env_plan"
          echo "useEnvironmentApply:   $use_env_apply"
          echo "useEnvironmentDestroy: $use_env_destroy"
          echo ""

          echo "---- Note ----"
          echo "If any job has 'environment: <non-empty>' that job will request approval from that environment's protection rules."


  # 1️⃣ INIT + FMT + VALIDATE
  init:
    if: ${{ inputs.runInit }}
    runs-on: self-hosted
    environment: ${{ inputs.useEnvironmentInit && inputs.environment || '' }}
    defaults:
      run:
        working-directory: ${{ env.WORKDIR }}
    steps:
      - uses: actions/checkout@v4

      - uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        
      - name: Terraform Init
        run: terraform init -input=false -backend-config="resource_group_name=${{ inputs.rgname }}" -backend-config="storage_account_name=${{ inputs.saname }}" -backend-config="container_name=${{ inputs.scname }}" -backend-config="key=${{ inputs.key }}"

      - run: terraform fmt -recursive
      - run: terraform validate


  # 2️⃣ PLAN
  plan:
    name: Terraform Plan
    needs: [init]
    if: ${{ inputs.runPlan && (needs.init.result == 'success' || !inputs.runInit) }}
    runs-on: self-hosted
    environment: ${{ inputs.useEnvironmentPlan && inputs.environment || '' }}

    defaults:
      run:
        working-directory: ${{ env.WORKDIR }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Terraform Init
        run: terraform init -input=false -backend-config="resource_group_name=${{ inputs.rgname }}" -backend-config="storage_account_name=${{ inputs.saname }}" -backend-config="container_name=${{ inputs.scname }}" -backend-config="key=${{ inputs.key }}"

      # Use below mentioned with , when in provider.tf > provider "azurerm" >   use_oidc = true (yeh agar true ho to)
      - name: Terraform Plan
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        run: terraform plan -var-file="../environments/prod.tfvars" -out="tf-plan-${{ inputs.environment }}.tfplan"
      # Yha tak wala block...

      # Use below mentioned with , when in provider.tf > provider "azurerm" > use_oidc = false (ya fir yeh line humne use hi nhi ki ho)
      # - name: Terraform Plan
        # run: terraform plan -var-file="../environments/prod.tfvars" -out="tf-plan-${{ inputs.environment }}.tfplan"
      # Yha tak wala block...

      - name: Upload plan
        uses: actions/upload-artifact@v4
        with:
          name: tf-plan-${{ inputs.environment }}.tfplan
          path: infra/tf-plan-${{ inputs.environment }}.tfplan
            

  # 3️⃣ APPLY
  apply:
    needs: [plan]
    if: ${{ inputs.runApply && needs.plan.result == 'success' }}
    runs-on: self-hosted
    environment: ${{ inputs.useEnvironmentApply && inputs.environment || '' }}
    defaults:
      run:
        working-directory: ${{ env.WORKDIR }}
    steps:

      - uses: actions/checkout@v4

      - uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  
      - name: Download plan
        uses: actions/download-artifact@v4
        with:
          name: tf-plan-${{ inputs.environment }}.tfplan
          path: infra

      - name: Terraform Init
        run: terraform init -input=false -backend-config="resource_group_name=${{ inputs.rgname }}" -backend-config="storage_account_name=${{ inputs.saname }}" -backend-config="container_name=${{ inputs.scname }}" -backend-config="key=${{ inputs.key }}"

      # Use below mentioned with , when in provider.tf > provider "azurerm" >   use_oidc = true (yeh agar true ho to)
      - name: Terraform Apply
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        # if: ${{ inputs.require_approval || github.event_name == 'push' }}
        run: terraform apply -auto-approve "tf-plan-${{ inputs.environment }}.tfplan"
      # Yha tak wala block...

      # Use below mentioned with , when in provider.tf > provider "azurerm" > use_oidc = false (ya fir yeh line humne use hi nhi ki ho)
      # - name: Terraform Apply
        # if: ${{ inputs.require_approval || github.event_name == 'push' }}
        # run: terraform apply -auto-approve "tf-plan-${{ inputs.environment }}.tfplan"
      # Yha tak wala block...


  # 4️⃣ DESTROY
  destroy:

    if: ${{ inputs.runDestroy }}
    runs-on: self-hosted
    environment: ${{ inputs.useEnvironmentDestroy && inputs.environment || '' }}
    defaults:
      run:
        working-directory: ${{ env.WORKDIR }}    
   
    steps:
      - uses: actions/checkout@v4

      - uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Terraform Init
        run: terraform init -input=false -backend-config="resource_group_name=${{ inputs.rgname }}" -backend-config="storage_account_name=${{ inputs.saname }}" -backend-config="container_name=${{ inputs.scname }}" -backend-config="key=${{ inputs.key }}"
      

      # Use below mentioned with , when in provider.tf > provider "azurerm" >   use_oidc = true (yeh agar true ho to)
      - name: Terraform Destroy
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        run: terraform destroy -auto-approve -var-file="../${{ inputs.tfvars_file }}"
      # Yha tak wala block...

      # Use below mentioned with , when in provider.tf > provider "azurerm" > use_oidc = false (ya fir yeh line humne use hi nhi ki ho)
      # - name: Terraform Destroy
      #   run: terraform destroy -auto-approve -var-file="../${{ inputs.tfvars_file }}"
      # Yha tak wala block...